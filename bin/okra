#! /usr/bin/env python

import argparse
import logging

from okra.logging_utils import enable_cloud_log

logger = logging.getLogger(__name__)


class _HelpAction(argparse._HelpAction):
    """ Reference: https://stackoverflow.com/questions/20094215 """

    def __call__(self, parser, namespace, values, option_string=None):
        parser.print_help()

        # retrieve subparsers from parser
        subparsers_actions = [
                action for action in parser._actions
                if isinstance(action, argparse._SubParsersAction)]

        # there will probably only be one subparser_action,
        # but better safe than sorry

        for subparsers_action in subparsers_actions:
            
            # get all subparsers and print help

            for choice, subparser in subparsers_action.choices.items():

                print("Subparser '{}'".format(choice))
                print(subparser.format_help())

            parser.exit()


parser = argparse.ArgumentParser(add_help=False)

parser.add_argument('--help', action=_HelpAction, help='big help')
parser.add_argument('task', action='store_true', help='name of task to perform (compute)')

subparsers = parser.add_subparsers(help='run these tasks, pass the bong')
task_parser = subparsers.add_parser("compute", help="compute the following")

task_parser.add_argument('-repo', help='git clone url to git repo')

# Configure logging

enable_cloud_log(level='INFO')

parsed_args = parser.parse_args()

print(parsed_args)
